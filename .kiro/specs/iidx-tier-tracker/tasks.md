# 実装タスクリスト

## 1. プロジェクト基盤のセットアップ
- [x] 1.1 (P)バックエンドのNode.js/Expressプロジェクトを初期化する
  - Expressサーバーの基本的なセットアップを行う。
  - 必要なnpmパッケージ（`express`, `cors`, `dotenv`）をインストールする。
  - `src`ディレクトリ構造を作成する。
  - _Requirements: 1, 2, 3, 4, 5_
- [x] 1.2 (P) フロントエンドのReact/Viteプロジェクトを初期化する
  - Viteを使用してReactプロジェクトの雛形を作成する。
  - 必要なnpmパッケージ（`axios`, `react-router-dom`）をインストールする。
  - `src`ディレクトリ構造（components, pages, services）を作成する。
  - _Requirements: 1, 2, 3, 5_
- [x] 1.3 Docker環境をセットアップする
  - `docker-compose.yml`を作成し、`postgres`サービスと`node`サービスを定義する。
  - `postgres`のデータ永続化のためのvolumeを設定する。
  - バックエンド用の`Dockerfile`を作成する。
  - _Requirements: 4_

## 2. データベースとデータモデルの実装
- [x] 2.1 データベーススキーマを定義する
  - `design.md`に基づき、`users`, `songs`, `user_lamps`, `lamp_history`テーブルを作成するためのSQLスクリプトを作成する。
  - _Requirements: 4.1_
- [x] 2.2 データベースマイグレーションツールを導入する
  - `node-pg-migrate`や`knex`などのマイグレーションツールをセットアップする。
  - 2.1で作成したスキーマ定義をマイグレーションファイルに変換する。
  - _Requirements: 4.2_
- [x] 2.3 データベース接続モジュールをバックエンドに作成する
  - `pg`パッケージを使用してPostgreSQLに接続するためのモジュールを実装する。
  - _Requirements: 4.1_

## 3. バックエンド(API)の実装
- [x] 3.1 ユーザー認証(AuthService)を実装する
  - Passport.jsと`passport-google-oauth20`をセットアップする。
  - Google Cloud ConsoleでOAuthクライアントIDとシークレットを取得し、`.env`ファイルに設定する。
  - `/auth/google`と`/auth/google/callback`のエンドポイントを実装する。
  - 認証成功時に`users`テーブルにユーザー情報を保存するロジックを実装する。
  - セッション管理のために`express-session`を設定する。
  - `/api/current_user`と`/api/logout`エンドポイントを実装する。
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
- [x] 3.2 楽曲・クリアランプ管理(TierTrackerService)のAPIを実装する
  - 楽曲リストを取得する`/api/songs`エンドポイントを実装する。
  - ログインユーザーのランプ情報を取得する`/api/lamps`エンドポイントを実装する。
  - ランプ情報を更新する`/api/lamps` (PUT)エンドポイントを実装する。更新時に`lamp_history`にも記録する。
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.2, 3.3_
- [x] 3.3 統計機能(TierTrackerService)のAPIを実装する
  - ランプの更新履歴を取得する`/api/stats/history`エンドポイントを実装する。
  - レベルごとのクリア状況サマリーを取得するAPIを実装する。
  - _Requirements: 5.1, 5.2_

## 4. フロントエンド(UI)の実装
- [x] 4.1 (P) 基本的なルーティングとレイアウトを実装する
  - `react-router-dom`を使用して、ホームページ、ログインページ、ダッシュボードページのルーティングを設定する。
  - ヘッダーやフッターなどの共通レイアウトコンポーネントを作成する。
  - _Requirements: 1, 2_
- [x] 4.2 (P) ユーザー認証関連のUIを実装する
  - `LoginButton`コンポーネントを作成し、クリック時にバックエンドの認証エンドポイントにリダイレクトさせる。
  - 認証状態を管理するためのReactコンテキストまたは状態管理ライブラリ（Zustandなど）をセットアップする。
  - 認証済みユーザーの情報を表示し、ログアウトボタンを提供する。
  - _Requirements: 1.2, 1.4_
- [x] 4.3 難易度表ページ(`MusicTable`)を実装する
  - レベル選択のUIを実装する。
  - 選択されたレベルの楽曲リストと、対応するユーザーのランプ情報をバックエンドから取得して表示する。
  - `LampSelector`コンポーネントを各楽曲に配置する。
  - 楽曲名でのフィルタリング機能を実装する。
  - _Requirements: 2.1, 2.2, 2.3, 2.4_
- [x] 4.4 ランプ更新機能(`LampSelector`)を実装する
  - ランプアイコンをクリックすると、ランプ状態の選択肢（ドロップダウンなど）を表示する。
  - 新しいランプ状態が選択されたら、バックエンドの更新APIを呼び出し、UIに即時反映させる。
  - _Requirements: 3.1, 3.2_
- [x] 4.5 統計ページ(`StatsDashboard`, `ContributionCalendar`)を実装する
  - バックエンドからランプ更新履歴を取得し、`ContributionCalendar`コンポーネントで可視化する。
  - レベルごとのクリア状況サマリーをグラフで表示する。
  - _Requirements: 5.1, 5.2_
- [x] 4.6 DP/SP切り替え機能を追加する
  - SP (Single Play) と DP (Double Play) の表示を切り替えるUI要素（ボタンやセレクト ボックスなど）を実装する。
  - 選択されたプレイモードに応じて、バックエンドから適切な楽曲リスト（SPまたはDPの譜面）を取得し表示を更新する。
  - _Requirements: 2.1, 2.2_

## 5. データインポート機能の実装
- [x] 5.1 Textageスクレイピングスクリプト(DataImportService)を実装する
  - `axios`で`textage.cc`のHTMLを取得する。
  - `cheerio`でHTMLをパースし、楽曲データを抽出するロジックを実装する。
  - 抽出したデータを`songs`テーブルに保存するロジックを実装する（重複チェックを含む）。
  - `npm run scrape`のようなコマンドで実行できるように`package.json`にスクリプトを追加する。
  - _Requirements: 2.0_
- [x] 5.2 TextageスクレイピングスクリプトにShift-JISからUTF-8への変換機能を追加する
  - Textageから取得した楽曲データがShift-JISエンコーディングである可能性を考慮し、データベースに保存する前にUTF-8に適切に変換する処理を実装する。
  - これにより、文字化けを防ぎ、多言語対応を強化する。
  - _Requirements: 2.0, 2.1_

## 6. 統合とテスト
- [x] 6.1 APIとフロントエンドの結合テストを行う
  - 実際にブラウザから操作し、すべての機能が設計通りに動作することを確認する。
  - 認証、ランプ更新、統計表示などの主要なフローをテストする。
  - _Requirements: 1, 2, 3, 5_
- [x] 6.2 単体テストと結合テストを作成する
  - [x] 6.2.1 バックエンドの`authService`に対して単体テストを作成する。
  - [x] 6.2.2 バックエンドの`dataImportService`の単体テストを修正する。
  - [x] 6.2.3 APIエンドポイントに対する結合テストを作成する（Supertestなどを使用）。
  - [x] 6.2.4 フロントエンドの主要コンポーネントの基本的なレンダリングテストを作成する（React Testing Libraryを使用）。
  - _Requirements: 1, 2, 3, 4, 5_

## 7. パフォーマンス改善
- [x] 7.1 ランプ更新時のChromeフリーズ問題の調査と解決
  - ランプを更新した際にChromeがフリーズする原因（重い処理、不要な再レンダリング、APIレスポンスの遅延など）を特定する。
  - 特定された問題に対する解決策を実装し、パフォーマンスを改善する。
  - _Requirements: 3.2_

## 8. デザインの実装
- [x] 8.1 Tailwind CSSのセットアップとダークモードの有効化
  - Tailwind CSSをフロントエンドプロジェクトに導入し、設定を最適化する。
  - `dark:` バリアントを使用して、アプリケーション全体のダークモード対応を有効にする。
  - _Requirements: (新規)_
- [x] 8.2 Magic UIの導入
  - Magic UIライブラリをプロジェクトにインストールし、基本的なコンポーネントが利用できるように設定する。
  - _Requirements: (新規)_
- [x] 8.3 楽曲カードへのGlassmorphismデザインの適用
  - 楽曲を表示するカードコンポーネント（例: `SongRow` または新しい `SongCard` コンポーネント）にGlassmorphism効果（背景のぼかし、半透明化など）を適用する。
  - _Requirements: (新規)_
- [x] 8.4 クリアランプへのNeon Glowデザインの適用
  - クリアランプを表示するコンポーネント（例: `LampSelector` 内）に、ランプの色に応じたNeon Glow効果（`box-shadow`による光の表現など）を適用する。
  - _Requirements: (新規)_
- [x] 8.5 ダークモード切り替えボタンの実装
  - アプリケーション全体でダークモードとライトモードを切り替えるUIボタンを実装する。
  - ユーザーの選択を `localStorage` に保存し、次回のアクセス時も設定が保持されるようにする。
  - _Requirements: (新規)_

## 9. ユーザーロールと権限管理
- [x] 9.1 管理者アカウントの識別機能の実装
  - 特定のアカウント（例: `google_id` やメールアドレス）を管理者として識別できるようにする。
  - ログイン中のユーザーが管理者であるかどうかを判別するロジックを実装する。
  - _Requirements: (新規)_

## 10. 開発環境ユーティリティ
- [x] 10.1 起動用shファイルを作成する
  - フロントエンドとバックエンドを同時に起動できるシェルスクリプトを作成する。
  - 開発環境のセットアップ手順を簡略化する。
  - _Requirements: (新規)_

## 11. 難易度細分化と管理者設定
- [x] 11.1 難易度細分化のためのデータモデル改修
  - 楽曲データに細分化された難易度を格納するためのフィールド（例: `sub_level` - 型は文字列または数値で、数値 (10.1, 10.2など) や「未分類」の文字列を扱えるようにする）を追加する。
- [x] 11.2 バックエンドAPIの改修
  - 細分化された難易度を楽曲データに含めて取得できるように `/api/songs` エンドポイントを修正する。
  - 管理者が細分化された難易度を更新できる新しいAPIエンドポイント（例: `PUT /api/songs/:id/sub_level`）を追加する。
- [x] 11.3 管理者向け難易度設定UIの実装
  - 管理者が手動で楽曲の細分化された難易度（`sub_level`）を設定・編集できるWebインターフェース（例: 入力フィールドやドロップダウンリスト）を実装する。このUIは「未分類」オプションも扱えるようにする。
  - D&D（ドラッグ＆ドロップ）で難易度を並べ替えられる実装とする。
  - [x] 11.3.1 D&Dライブラリの調査と選定
- [x] 11.4 フロントエンドの表示ロジック改修
  - 絞り込み後、楽曲リストに細分化された難易度を表示するようにUIを修正する。
  - _Requirements: (新規)_